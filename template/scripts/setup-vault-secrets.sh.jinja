#!/bin/bash
set -e

# Setup Vault Secrets for {{ project_name }}
# Run this after Vault is initialized and unsealed
#
# Usage:
#   ./scripts/setup-vault-secrets.sh
#
# Prerequisites:
#   - Vault is running and unsealed
#   - VAULT_ADDR and VAULT_TOKEN environment variables are set

VAULT_ADDR=${VAULT_ADDR:-"http://localhost:8200"}
SERVICE_NAME="{{ service_name }}"

echo "=== Vault Secrets Setup ==="
echo "Vault Address: $VAULT_ADDR"

# Check if logged in
if ! vault token lookup > /dev/null 2>&1; then
    echo "ERROR: Not logged into Vault. Please run: vault login"
    exit 1
fi

echo ""
echo "Step 1: Enable KV secrets engine..."
vault secrets enable -path=${SERVICE_NAME} kv-v2 2>/dev/null || echo "KV engine already enabled"

echo ""
echo "Step 2: Enable AppRole auth..."
vault auth enable approle 2>/dev/null || echo "AppRole already enabled"

echo ""
echo "Step 3: Create policy for ${SERVICE_NAME}..."
vault policy write ${SERVICE_NAME}-policy - <<POLICY_EOF
# Allow reading secrets for ${SERVICE_NAME}
path "${SERVICE_NAME}/data/*" {
  capabilities = ["read"]
}

path "${SERVICE_NAME}/metadata/*" {
  capabilities = ["list"]
}
POLICY_EOF

echo ""
echo "Step 4: Create AppRole for ${SERVICE_NAME}..."
vault write auth/approle/role/${SERVICE_NAME}-agent \
    token_policies="${SERVICE_NAME}-policy" \
    token_ttl=1h \
    token_max_ttl=4h \
    secret_id_ttl=0

echo ""
echo "Step 5: Get Role ID and Secret ID..."
ROLE_ID=$(vault read -field=role_id auth/approle/role/${SERVICE_NAME}-agent/role-id)
SECRET_ID=$(vault write -field=secret_id -f auth/approle/role/${SERVICE_NAME}-agent/secret-id)

echo ""
echo "=== AppRole Credentials ==="
echo "Role ID: $ROLE_ID"
echo "Secret ID: $SECRET_ID"
echo ""
echo "Save these! You'll need them for Vault Agent."

# Save to files
AGENT_DIR="./deploy/ops/configs/vault/agent"
if [ -d "$AGENT_DIR" ]; then
    echo ""
    echo "Saving credentials to $AGENT_DIR..."
    echo "$ROLE_ID" > "$AGENT_DIR/role-id"
    echo "$SECRET_ID" > "$AGENT_DIR/secret-id"
    chmod 600 "$AGENT_DIR/role-id" "$AGENT_DIR/secret-id"
    echo "Done!"
fi

echo ""
echo "Step 6: Store secrets..."
echo "You can store secrets with:"
echo ""
echo "  vault kv put ${SERVICE_NAME}/dev \\"
echo "    DATABASE_URL=\"postgresql://...\" \\"
echo "    API_KEY=\"your-api-key\""
echo ""
echo "=== Setup Complete ==="
