#!/bin/bash
set -e

# =============================================================================
# VPS Setup Script
# =============================================================================
# Usage:
#   ./scripts/setup-vps.sh [dev|prod]
# =============================================================================

ENV=${1:-dev}
DEPLOY_DIR="/opt/[[ .project_name ]]"
REPO_DIR="${DEPLOY_DIR}/repo"

echo "=== [[ .project_name ]] VPS Setup ==="
echo "Environment: ${ENV}"
echo ""

# -----------------------------------------------------------------------------
# 1. Install Docker
# -----------------------------------------------------------------------------
echo "Step 1: Installing Docker..."
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com | sh
    systemctl enable docker
    systemctl start docker
    echo "Docker installed successfully"
else
    echo "Docker already installed"
fi

# -----------------------------------------------------------------------------
# 2. Create directories
# -----------------------------------------------------------------------------
echo ""
echo "Step 2: Creating directories..."
mkdir -p ${DEPLOY_DIR}
mkdir -p ${REPO_DIR}

# -----------------------------------------------------------------------------
# 3. Clone/update repository
# -----------------------------------------------------------------------------
echo ""
echo "Step 3: Setting up repository..."
if [ -d "${REPO_DIR}/.git" ]; then
    echo "Updating existing repo..."
    cd ${REPO_DIR}
    git pull origin master
else
    echo "Please clone the repository manually:"
    echo ""
    echo "  git clone https://\${GITHUB_PAT}@github.com/[[ .github_owner ]]/[[ .project_name ]]-deployments.git ${REPO_DIR}"
    echo ""
    echo "Then run this script again."
    exit 1
fi

# -----------------------------------------------------------------------------
# 4. Copy files
# -----------------------------------------------------------------------------
echo ""
echo "Step 4: Copying deployment files..."
cp ${REPO_DIR}/deploy/docker-compose.*.yml ${DEPLOY_DIR}/
cp -r ${REPO_DIR}/deploy/ops ${DEPLOY_DIR}/
cp -r ${REPO_DIR}/deploy/app ${DEPLOY_DIR}/

# -----------------------------------------------------------------------------
# 5. Configure environment
# -----------------------------------------------------------------------------
echo ""
echo "Step 5: Configure environment..."
echo "Edit the following files:"
echo "  ${DEPLOY_DIR}/ops/overlays/${ENV}/.env"
echo "  ${DEPLOY_DIR}/app/overlays/${ENV}/.env"
echo ""
read -p "Press Enter after editing, or Ctrl+C to exit..."

# -----------------------------------------------------------------------------
# 6. Login to GHCR
# -----------------------------------------------------------------------------
echo ""
echo "Step 6: Docker registry login..."
if [ ! -f /root/.docker/config.json ]; then
    echo "Login to GitHub Container Registry:"
    echo "  echo \"\$GITHUB_PAT\" | docker login ghcr.io -u YOUR_USERNAME --password-stdin"
    echo ""
    read -p "Press Enter after logging in..."
fi

# -----------------------------------------------------------------------------
# 7. Start services
# -----------------------------------------------------------------------------
echo ""
echo "Step 7: Starting services..."
cd ${DEPLOY_DIR}

# Create network
docker network create infra-network 2>/dev/null || true

# Start services
docker compose \
    -f docker-compose.ops.yml \
    -f ops/overlays/base/docker-compose.yml \
    -f ops/overlays/${ENV}/docker-compose.yml \
    -f docker-compose.app.yml \
    -f app/overlays/base/docker-compose.yml \
    -f app/overlays/${ENV}/docker-compose.yml \
    --profile caddy[[ if .promtail ]] --profile promtail[[ end ]][[ if .watchtower ]] --profile watchtower[[ end ]] \
    up -d

# -----------------------------------------------------------------------------
# 8. Done
# -----------------------------------------------------------------------------
echo ""
echo "=== Setup Complete ==="
echo ""

docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo ""
echo "Next steps:"
[[ if .vault ]]
echo "  1. Initialize Vault: docker exec -it vault vault operator init"
echo "  2. Unseal Vault:     docker exec -it vault vault operator unseal"
[[ end ]]
echo "  3. Configure DNS in Cloudflare"
