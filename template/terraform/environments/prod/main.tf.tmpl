terraform {
  required_version = ">= 1.0"

  required_providers {
[[ if .cloudflare ]]
    cloudflare = {
      source  = "cloudflare/cloudflare"
      version = "~> 4.0"
    }
[[ end ]]
[[ if .hetzner ]]
    hcloud = {
      source  = "hetznercloud/hcloud"
      version = "~> 1.45"
    }
[[ end ]]
[[ if .supabase ]]
    supabase = {
      source  = "supabase/supabase"
      version = "~> 1.0"
    }
[[ end ]]
  }

  # Uncomment to use remote state
  # backend "s3" {
  #   bucket = "your-terraform-state-bucket"
  #   key    = "[[ .project_name ]]/prod/terraform.tfstate"
  #   region = "eu-central-1"
  # }
}
[[ if .cloudflare ]]

provider "cloudflare" {
  api_token = var.cloudflare_api_token
}
[[ end ]]
[[ if .hetzner ]]

provider "hcloud" {
  token = var.hetzner_api_token
}
[[ end ]]
[[ if .supabase ]]

provider "supabase" {
  access_token = var.supabase_access_token
}
[[ end ]]
[[ if .supabase ]]

# =============================================================================
# SUPABASE
# =============================================================================
module "supabase" {
  source = "../../modules/supabase"

  organization_id   = var.supabase_organization_id
  project_name      = "[[ .project_name ]]-prod"
  database_password = var.supabase_database_password
  region            = var.supabase_region

  site_url                 = "https://app.${var.domain}"
  additional_redirect_urls = var.supabase_additional_redirect_urls
  disable_signup           = var.supabase_disable_signup
  mailer_autoconfirm       = false
  jwt_expiry_seconds       = 3600

  enable_captcha = var.supabase_enable_captcha
  captcha_secret = var.supabase_captcha_secret
}
[[ end ]]
[[ if .cloudflare ]]

# =============================================================================
# CLOUDFLARE
# =============================================================================
module "cloudflare" {
  source = "../../modules/cloudflare"

  cloudflare_account_id = var.cloudflare_account_id
  cloudflare_zone_id    = var.cloudflare_zone_id

  backend_subdomain = "api"
  backend_server_ip = var.backend_server_ip

  pages_project_name = "[[ .project_name ]]-frontend"
  production_branch  = "master"
  build_command      = "npm run build"
  build_output_dir   = "dist"

  github_owner = var.github_owner
  github_repo  = var.github_frontend_repo

  frontend_env_vars = {
    VITE_API_URL           = "https://api.${var.domain}"
[[ if .supabase ]]
    VITE_SUPABASE_URL      = module.supabase.project_url
    VITE_SUPABASE_ANON_KEY = var.supabase_anon_key
[[ end ]]
  }

  frontend_custom_domain = var.frontend_custom_domain
  frontend_subdomain     = "app"
}
[[ end ]]
[[ if .hetzner ]]

# =============================================================================
# HETZNER
# =============================================================================
module "hetzner" {
  source = "../../modules/hetzner"

  project_name = "[[ .project_name ]]"
  environment  = "prod"

  create_server   = false
  create_firewall = var.create_hetzner_firewall

  ssh_allowed_ips = var.ssh_allowed_ips
}
[[ end ]]
